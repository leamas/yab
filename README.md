rpmdev-patchbuild README
========================

rpmbuild-patchbuild is a simple script which synchronizes the patches
in a RPM specfile and a build tree. The idea is to simplify the
workflow
  - Unpacking the sources.
  - Apply existing patches to sources without losing history, so
    the patches are available for updating.
  - Modify sources.
  - Create new patches.
  - Update patches in the spec file.
  - Rebuild.

Dependencies
============

You need at least git, quilt and rpmdev-tools.

Installation
============

None. Just run the script, possibly after dropping it somewhere in
your path.

The manpage could be viewed using *nroff -man rpmdev-patchbuild.1*

Ah, the manpage:

<hr>



<HTML><HEAD><TITLE>Manpage of RPMDEV-PATCHBUILD</TITLE>
</HEAD><BODY>
<H1>RPMDEV-PATCHBUILD</H1>
Section: User Commands (1)<BR>Updated: Last change: $Format:%ci$<BR><A HREF="#index">Index</A>
<A HREF="http://linux.die.net/man">Return to Main Contents</A><HR>

<A NAME="lbAB">&nbsp;</A>
<H2>NAME</H2>

rpmdev-patchbuild - synchronize patch set between spec and source
<A NAME="lbAC">&nbsp;</A>
<H2>SYNOPSIS</H2>

<B>rpmdev-patchbuild [</B><I>options</I>] &lt;<I>command</I>&gt; [<I>spec file</I>]

<A NAME="lbAD">&nbsp;</A>
<H2>DESCRIPTION</H2>

<I>rpmdev-patchbuild</I> is designed to support the workflow when
maintaining patches in RPM spec files. It can export existing
patches to a build tree. This build tree can be modified with new
or updated patches. Eventually, the patches in the spec file can
be updated (i. e., replaced) with the patches in the build tree.
<A NAME="lbAE">&nbsp;</A>
<H2>ARGUMENTS</H2>

The <B>command</B> argument is one of
<DL COMPACT><DT><DD>
<DL COMPACT>
<DT><I>export</I><DD>
Retrieves the sources as defined in the spec file and unpacks them into
a build tree. The patches in the spec are applied as a patch series in this
tree.
<DT><I>import</I><DD>
Import the patches from the build tree. The patches in the spec file are
replaced with the patches from build tree.
<DT><I>status</I><DD>
Display the patch status. A patch can be deleted, new, modified or
unchanged. A new patch might conflict if using a numeric prefix used
by another patch
<DT><I>reset</I><DD>
Reset the patch numbering (git mode only). Removes existing patches and
replaces them with a new set generated by <I>git format-patch</I>.
<DT><I>version</I><DD>
Print version
</DL>
</DL>

<DL COMPACT>
<DT><B>spec file</B><DD>
The spec file to use. Defaults to <I>*.spec</I> (which must match a single
file to work).
<P>
</DL>
<A NAME="lbAF">&nbsp;</A>
<H2>OPTIONS</H2>

<DL COMPACT>
<DT><B>-m</B> ,<B>--mode</B> [<I>git</I>|<I>quilt</I>|<I>autosetup</I>]<DD>
Work either in  git,  quilt or autosetup mode. See QUILT MODE, GIT MODE,
and AUTOSETUP MODE. Modes can be abridged to the initial letters <I>g</I>,
<I>q</I> and <I>a</I>.
<DT><B>-o</B>,<B>--options</B><DD>
Options used with  <I>%patch</I> when importing new patches. Defaults to
<I>-p1</I>. Existing <I>%patch</I> invocations are used as-is.
<DT><B>-w</B>,<B>--working-dir</B><DD>
Build directory where sources are unpacked. Defaults to <I>patchbuild</I>.
<DT><B>-h</B>,<B>--help</B><DD>
Display usage summary.
<DT><B>-v</B>,<B>--version</B><DD>
Display version.
<P>
</DL>
<A NAME="lbAG">&nbsp;</A>
<H2>QUILT MODE</H2>

In quilt mode the build tree is initiated with a <I><A HREF="http://linux.die.net/man/1/quilt">quilt</A>(1)</I>
patchset. This mode can always be used for &quot;normal&quot; spec files
using %patch to apply the patches. It does not parse or generate
any patch metadata. It also leaves patch naming including numbering
to the user. After a <I>quilt refresh</I> command the patchset is
updated and visible for rpmdev-patchbuild. Quilt mode is
used by default if at least one patch is deemed as non-git.
<P>
<A NAME="lbAH">&nbsp;</A>
<H2>GIT  MODE</H2>

<P>

In git mode the build tree is initiated with a <I><A HREF="http://linux.die.net/man/1/git">git</A>(1)</I>
repository, and each patch in the spec will be applied using
<I>git am</I>. Requires that all spec patches are git-formatted.
This mode is used by default if all patches in the spec are deemed
as git patches according to some heuristics.
<P>

<B>rpmdev-patchbuild</B> does not import the git repo directly, it
uses the <I>patchbuild/patches</I> directory. One way to feed it
is to just invoke something like <I>git format-patch --start-number 7
<BR>&nbsp;-o&nbsp;../patches&nbsp;HEAD^..HEAD</I>.&nbsp;This&nbsp;gives&nbsp;user&nbsp;fine-grained&nbsp;control&nbsp;over
the patches imported. The alternative is to use the <I>reset</I> command
which generates a fresh, re-numbered patchset in ../patches.
<P>

In git mode all changes done by %prep besides the actual patching is
discarded by <I>export</I>.
<P>
<A NAME="lbAI">&nbsp;</A>
<H2>AUTOSETUP MODE</H2>

In the autosetup mode <B>rpmdev-patchbuild</B> assumes that the  spec file
doesn't use <I>%patch</I> macros for applying the patches. No modifications
are done to the %prep section in the spec file, only the <I>Patch:</I> tag
lines are parsed and modified. Likewise, no modifications are done to the
spec when it is used to unpack the sources in the <I>export</I> command.
<P>

Like in the git mode, only the patches/ directory is consulted for the actual
patchset. This means that <B>rpmdev-patchbuild</B> is agnostic as to how this
is created. A common way would be the <I>git format-patch</I> described for
the git mode.
<P>
<A NAME="lbAJ">&nbsp;</A>
<H2>SPEC FILE MODIFICATIONS</H2>

Updating an existing patch does not affect the spec file, only the contents
of the patch file.
<P>

When deleting a patch the corresponding entry in the spec is commented
out.
<P>

When inserting a new patch, the <I>Patch:</I> tag line and the <I>%patch</I>
is inserted ordered to existing lines. If there is no existing patch the
tag line is inserted after the last Source: and the patch line after %setup.
<P>

Both deleted and inserted patches creates fixes which looks ugly and needs
some manual editing before committing.
<P>

When imported a new patch must be designated a number. If the patch
filename doesnt have a numeric prefix the next available number is
used. It the patch has a numeric prefix it will be used unless it's
already used in the spec. In this case there is a warning and next
available number is used.
<P>
<A NAME="lbAK">&nbsp;</A>
<H2>EXAMPLES</H2>

A session using <B>rpmdev-patchbuild</B> might look like:
<PRE>
    $ fedpkg clone foo
    $ cd foo
    $ rpmdev-patchbuild export
    $ cd patchbuild/foo-1.0.3
    &lt; patch the code and update patches&gt;
    $ cd ../..
    $ rpmdev-patchbuild status
    $ rpmdev-patchbuild import
    $ rpmbuild -D &quot;_sourcedir $PWD&quot; -ba *.spec
    &lt; patch broken... fix in patchbuild/foo-1.0.3&gt;
    $ rpmdev-patchbuild import
    $ rpmbuild -D &quot;_sourcedir $PWD&quot; -ba *.spec
    &lt;all OK, commit changes in main git repo&gt;
    $ git commit -am &quot;foo fixed with new patches&quot;
</PRE>

<P>
<A NAME="lbAL">&nbsp;</A>
<H2>BUGS</H2>

<P>
When unpacking the build dependencies are not used. In corner cases where the
%prep section uses tools from the builddeps the export command will fail.
Installing the build dependencies for the spec file should fix it.
<P>

If a specfile unpacks two or more separate directories in the top level
<B>rpmdev-patchbuild</B> gets confused.
<P>
<A NAME="lbAM">&nbsp;</A>
<H2>SEE ALSO</H2>

<P>
<A HREF="http://linux.die.net/man/1/quilt">quilt</A>(1)
<BR>

<A HREF="http://linux.die.net/man/1/git">git</A>(1)
<BR>

<P>
<P>
<P>

<HR>
<A NAME="index">&nbsp;</A><H2>Index</H2>
<DL>
<DT><A HREF="#lbAB">NAME</A><DD>
<DT><A HREF="#lbAC">SYNOPSIS</A><DD>
<DT><A HREF="#lbAD">DESCRIPTION</A><DD>
<DT><A HREF="#lbAE">ARGUMENTS</A><DD>
<DT><A HREF="#lbAF">OPTIONS</A><DD>
<DT><A HREF="#lbAG">QUILT MODE</A><DD>
<DT><A HREF="#lbAH">GIT  MODE</A><DD>
<DT><A HREF="#lbAI">AUTOSETUP MODE</A><DD>
<DT><A HREF="#lbAJ">SPEC FILE MODIFICATIONS</A><DD>
<DT><A HREF="#lbAK">EXAMPLES</A><DD>
<DT><A HREF="#lbAL">BUGS</A><DD>
<DT><A HREF="#lbAM">SEE ALSO</A><DD>
</DL>
<HR>
This document was created by
<A HREF="http://linux.die.net/man">man2html</A>,
using the manual pages.<BR>
Time: 13:56:07 GMT, October 23, 2015
</BODY>
</HTML>
